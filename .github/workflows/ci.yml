name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run ShellCheck
        run: make shellcheck

  test-template:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: go-only
            languages: go
          - name: python-only
            languages: python
          - name: go-python
            languages: go,python
          - name: all-languages
            languages: go,python,proto
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Install tools
        run: pip install copier ruff pip-tools
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      - uses: bazel-contrib/setup-bazel@0.14.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}-${{ matrix.name }}
          repository-cache: true
      - name: Test template
        run: make test-template LANGUAGES="${{ matrix.languages }}"

  test-template-tagged:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Install tools
        run: pip install copier ruff pip-tools
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      - uses: bazel-contrib/setup-bazel@0.14.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}-tagged
          repository-cache: true
      - name: Test template (tagged)
        run: make test-template-tagged

  test-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install copier
        run: pip install copier
      - name: Test update
        run: make test-update

  test-update-tagged:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install copier
        run: pip install copier
      - name: Test update (tagged)
        run: make test-update-tagged

  test-migrate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: go-basic
            target: test-migrate-go
          - name: go-gradual
            target: test-migrate-go-gradual
          - name: python-basic
            target: test-migrate-python
          - name: go-python-mixed
            target: test-migrate-mixed
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Install copier
        run: pip install copier
      - uses: bazel-contrib/setup-bazel@0.14.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}-migrate-${{ matrix.name }}
          repository-cache: true
      - name: Test migration
        run: make ${{ matrix.target }}

  test-migrate-tagged:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Install copier
        run: pip install copier
      - uses: bazel-contrib/setup-bazel@0.14.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}-migrate-tagged
          repository-cache: true
      - name: Test migration (tagged)
        run: make test-migrate-tagged
