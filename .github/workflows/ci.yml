name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'

  test-template:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: go-only
            languages: go
          - name: python-only
            languages: python
          - name: go-python
            languages: go,python
          - name: all-languages
            languages: go,python,proto
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install copier and tools
        run: |
          pip install copier
          pip install ruff

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Create project from template
        run: |
          ./create-project.sh -y \
            -n test-project \
            -o testorg \
            -l "${{ matrix.languages }}" \
            /tmp/test-project

      - uses: bazel-contrib/setup-bazel@0.14.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}-${{ matrix.name }}
          repository-cache: true

      - name: Create placeholder Go file for linting
        if: contains(matrix.languages, 'go')
        run: |
          mkdir -p /tmp/test-project/cmd/hello
          printf 'package main\n\nfunc main() { println("hello") }\n' > /tmp/test-project/cmd/hello/main.go

      - name: Build and test generated project
        run: make all
        working-directory: /tmp/test-project

  test-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install copier
        run: pip install copier

      - name: Create then update project
        run: |
          ./create-project.sh -y -n test-project /tmp/test-project
          cd /tmp/test-project
          git init -b main
          git config user.name "CI"
          git config user.email "ci@example.com"
          git add .
          git commit -m "Initial commit"
          cd -
          ./update-project.sh -y --head /tmp/test-project
